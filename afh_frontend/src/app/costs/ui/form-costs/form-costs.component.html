<p-dialog
  header="{{ this.actionTittle }}"
  [modal]="true"
  [(visible)]="visible"
  [style]="{ width: '60rem' }"
  [closable]="true"
  (onHide)="close()"
>
  <p-toast position="top-right"></p-toast>
  <div class="w-full mx-auto rounded-xl justify-center mt-2 serenityBlue">
    <!-- Contenedor flexible: si no hay orden válida el input ocupa todo el ancho, si hay orden válida se divide en 2 -->
    <div
      class="grid gap-4 text-darkBlue"
      [ngClass]="{
        'grid-cols-1 mb-30': validOrder === false,
        
      }"
    >
      <!-- Input de código de orden -->
      <div class="mb-4">
        <h1 class="mb-4 font-medium">
          Ingrese el código de la orden de trabajo.
        </h1>
        <p-autocomplete
          [(ngModel)]="selectedOrderWork"
          (ngModelChange)="onOrderChange()"
          placeholder="Código de la orden de trabajo"
          [suggestions]="filteredOrderWork ?? []"
          (completeMethod)="filterWorkReport($event)"
          [disabled]="this.action === 1"
          [ngClass]="{
            'bg-gray-200 text-gray-500': this.action === 1,
            'ng-invalid ng-dirty border-red-500':
              errorMessage &&
              selectedOrderWork === null &&
              errorOrderInvalidMessage
          }"
          class="w-full bg-white serenityBlue font-normal rounded-lg transition focus:ring-2 focus:ring-primary-900"
          optionLabel="quote.code"
          fluid="true"
        />
        <small
          id="email-help"
          class="text-red-600 mb-4"
          *ngIf="
            (errorMessage && selectedOrderWork === null) ||
            errorOrderInvalidMessage
          "
        >
          {{
            errorMessage && selectedOrderWork === null
              ? errorMessage
              : errorOrderInvalidMessage
          }}
        </small>
      </div>

      <!-- Ítems: solo visibles si validOrder es true o action = 1 -->
      <div
        class="p-4 flex flex-col gap-4 bg-white border rounded-lg"
        *ngIf="validOrder || action === 1"
      >
        <div class="grid grid-cols-2 gap-4">
          <h1 class="font-bold">Items del costo</h1>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            *ngFor="let item of itemsPorOpcion.items; let j = index"
            [ngClass]="{
              'col-span-3':
                itemsPorOpcion.items.length === 1 ||
                (itemsPorOpcion.items.length % 3 === 1 &&
                  j === itemsPorOpcion.items.length - 1)
            }"
            class="relative flex flex-col gap-4"
          >
            <div class="flex flex-col gap-2">
              <p-floatlabel variant="on" required="true">
                <textarea
                  pTextarea
                  type="text"
                  rows="5"
                  cols="30"
                  [(ngModel)]="item.description"
                  [ngClass]="{
                    'ng-invalid ng-dirty border-red-500':
                      errorMessage && item.description === ''
                  }"
                  [ngModelOptions]="{ standalone: true }"
                  class="w-full bg-white serenityBlue font-normal rounded-lg transition focus:ring-2 focus:ring-primary-500"
                ></textarea>
                <label for="desc{{ j }}">Descripción ítem {{ j + 1 }}</label>
              </p-floatlabel>

              <small
                id="email-help"
                class="text-red-600"
                *ngIf="errorMessage && item.description === ''"
              >
                {{ errorMessage }}
              </small>
            </div>

            <div class="flex flex-col gap-2">
              <p-float-label variant="on" required="true">
                <p-autocomplete
                  [(ngModel)]="item.units"
                  [ngClass]="{
                    'ng-invalid ng-dirty border-red-500':
                      errorMessage && item.units === ''
                  }"
                  [dropdown]="true"
                  [suggestions]="filteredUnits"
                  (completeMethod)="search($event)"
                  class="bg-white serenityBlue font-normal rounded-lg transition focus:ring-2 focus:ring-primary-500"
                  fluid="true"
                />
                <label>Unidad de medida o tipo del item</label>
              </p-float-label>

              <small
                id="email-help"
                class="text-red-600"
                *ngIf="errorMessage && item.units === ''"
              >
                {{ errorMessage }}
              </small>
            </div>

            <div class="flex flex-col gap-2">
              <p-floatlabel variant="on" required="true">
                <p-inputnumber
                  [(ngModel)]="item.amount"
                  inputId="locale-user"
                  [minFractionDigits]="2"
                  [ngClass]="{
                    'ng-invalid ng-dirty border-red-500':
                      errorMessage &&
                      (item.amount === 0 || item.amount === null)
                  }"
                  (ngModelChange)="updatePrice()"
                  class="w-full bg-white serenityBlue font-normal rounded-lg transition focus:ring-2 focus:ring-primary-500"
                />
                <label for="cantidad{{ j }}">Cantidad</label>
              </p-floatlabel>

              <small
                id="email-help"
                class="text-red-600"
                *ngIf="
                  errorMessage && (item.amount === 0 || item.amount === null)
                "
              >
                {{ errorMessage }}
              </small>
            </div>

            <div class="flex flex-col gap-2">
              <p-floatlabel variant="on" required="true">
                <p-inputnumber
                  inputId="integeronly"
                  [(ngModel)]="item.unit_value"
                  [ngClass]="{
                    'ng-invalid ng-dirty border-red-500':
                      errorMessage &&
                      (item.unit_value === 0 || item.unit_value === null)
                  }"
                  (ngModelChange)="updatePrice()"
                  [ngModelOptions]="{ standalone: true }"
                  class="w-full bg-white serenityBlue font-normal rounded-lg transition focus:ring-2 focus:ring-primary-500"
                />
                <label for="valor{{ j }}">Valor unitario</label>
              </p-floatlabel>

              <small
                id="email-help"
                class="text-red-600"
                *ngIf="
                  errorMessage &&
                  (item.unit_value === 0 || item.unit_value === null)
                "
              >
                {{ errorMessage }}
              </small>
            </div>

            <p-floatlabel variant="on" required="true">
              <input
                pInputText
                type="number"
                [disabled]="true"
                [(ngModel)]="item.total_value"
                (ngModelChange)="updateTotalPrice()"
                [ngModelOptions]="{ standalone: true }"
                class="w-full bg-white text-gray-600 font-normal rounded-lg transition focus:ring-2 focus:ring-primary-500"
              />
              <label for="precio{{ j }}">Precio total del item</label>
            </p-floatlabel>

            <button
              *ngIf="itemsPorOpcion.items.length > 1 && this.action === 0"
              type="button"
              (click)="removeItem(j, 0)"
              class="absolute top-0 right-0 text-gray-500 hover:text-gray-700 font-bold text-lg cursor-pointer"
              title="Eliminar"
            >
              &times;
            </button>
            <button
              *ngIf="itemsPorOpcion.items.length > 1 && this.action === 1"
              type="button"
              (click)="removeItem(j, item.id)"
              class="absolute top-0 right-0 text-gray-500 hover:text-gray-700 font-bold text-lg cursor-pointer"
              title="Eliminar"
            >
              &times;
            </button>
          </div>
        </div>

        <div class="w-full">
          <p-button
            label="Agregar ítem"
            icon="pi pi-plus"
            styleClass="createButton-lightSerenityGreen"
            fluid="true"
            (onClick)="addItem()"
          ></p-button>
        </div>

        <div>
          <h1 class="text-left font-medium">Subtotal: {{ getTotalPrice() }}</h1>
        </div>
      </div>

      <div
        class="flex justify-end gap-2 mt-10"
        *ngIf="this.validOrder === true || this.action === 1"
      >
        <p-button styleClass="p-button-secondary" (onClick)="close()">
          Cancelar
        </p-button>
        <p-button
          styleClass="createButton-lightSerenityGreen font-medium"
          [loading]="loadingCreate"
          (onClick)="submit()"
        >
          {{ this.actionTittle }}
        </p-button>
      </div>
    </div>
  </div>
</p-dialog>
