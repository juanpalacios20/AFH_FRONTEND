<div class="relative h-screen">
  <app-menu class="absolute top-0 left-0 p-4"></app-menu>
  <p-toast position="top-right"></p-toast>

  <div class="w-full p-5 pt-20 space-y-4">
    <!-- Título -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
      <h1 class="text-2xl font-bold text-center md:text-left serenityGreen">
        AFH: Historial de Vales
      </h1>
    </div>

    <!-- Buscador -->
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-3"
    >
      <div class="w-full md:w-auto">
        <p-floatlabel variant="on" class="w-full md:w-64">
          <p-iconfield>
            <p-inputicon class="pi pi-search" rounded="true" />
            <input
              pInputText
              id="search"
              [(ngModel)]="code"
              (input)="tti?.filterGlobal(code, 'contains')"
              autocomplete="off"
              class="w-full serenityBlue focus:ring-2 focus:ring-primary-900"
            />
          </p-iconfield>
          <label for="search" class="serenityBlue">Buscar vale</label>
        </p-floatlabel>
        <small
          id="search-help"
          class="text-gray-500 block text-center md:text-left"
        >
          Busca por código y lugar destino
        </small>
      </div>
    </div>

    <!-- Confirmación -->
    <p-confirmdialog></p-confirmdialog>

    <!-- Tabla -->
    <div class="overflow-x-auto">
      <p-table
        #tti
        [value]="ticketsFinalizados"
        [rows]="20"
        [paginator]="true"
        [tableStyle]="{ 'min-width': '50rem' }"
        [rowsPerPageOptions]="[20, 50, 100]"
        [globalFilterFields]="['id', 'place']"
      >
        <ng-template #header *ngIf="ticketsFinalizados.length > 0">
          <tr>
            <th class="rounded-border serenityBlue text-center">Código</th>
            <th class="rounded-border serenityBlue text-center">
              Lugar Destino
            </th>
            <th class="rounded-border serenityBlue text-center">Fecha</th>
            <th class="rounded-border serenityBlue text-center">Estado</th>
          </tr>
        </ng-template>

        <ng-template #body let-ticket>
          <tr>
            <td
              class="cursor-pointer serenityBlue"
              (click)="showViewTicketDialog(ticket.id)"
            >
              <p class="text-center serenityBlue">{{ ticket.id }}</p>
            </td>
            <td
              class="cursor-pointer serenityBlue"
              (click)="showViewTicketDialog(ticket.id)"
            >
              <p class="text-center serenityBlue">{{ ticket.place }}</p>
            </td>
            <td
              class="cursor-pointer serenityBlue"
              (click)="showViewTicketDialog(ticket.id)"
            >
              <p class="text-center serenityBlue">{{ ticket.entry_date_formatted }}</p>
            </td>
            <td
              class="cursor-pointer"
              (click)="showViewTicketDialog(ticket.id)"
            >
              <div class="flex justify-center">
                <p-tag
                  class="justify-center"
                  [value]="getStateString(ticket.state)"
                  [severity]="getSeverity(ticket.state)"
                ></p-tag>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template
          #emptymessage
          *ngIf="ticketsFinalizados.length === 0 && loadingTickets === false"
        >
          <tr>
            <td colspan="4" class="text-center text-gray-600">
              No hay vales finalizados
            </td>
          </tr>
        </ng-template>

        <ng-template
          #emptymessage
          *ngIf="ticketsFinalizados.length === 0 && loadingTickets === true"
        >
          <tr>
            <td colspan="4" class="text-center text-gray-600">
              Cargando información...
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Dialog -->
  <app-view-ticket
    [state]="state"
    [date]="date"
    [description]="description"
    [place]="place"
    [id]="id"
    [responsible]="responsible"
    [dateEnd]="dateEnd"
    [tools]="tools"
    [visible]="viewTicketDialogVisible"
    (closeDialog)="viewTicketDialogVisible = false"
  ></app-view-ticket>
</div>
